<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movies</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f4f4f4;
        }
        button {
            padding: 5px 10px;
            border: none;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button.delete {
            background-color: #dc3545;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        .pagination button {
            margin: 0 5px;
            padding: 5px 10px;
            border: 1px solid #000;
            background-color: transparent;
            color: #000;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }
        .pagination button.selected {
            background-color: #007bff;
            color: #fff;
            border: none;
        }
    </style>
</head>
<body>
<h1>Movie List</h1>
<div>
    <input
            type="text"
            id="search-bar-title"
            placeholder="Search by Title"
            oninput="searchMoviesByTitle()"
            style="margin-bottom: 20px; padding: 10px; width: 100%; box-sizing: border-box;"
    />
    <input
            type="text"
            id="search-bar-genre"
            placeholder="Search by Genre"
            oninput="searchMoviesByGenre()"
            style="margin-bottom: 20px; padding: 10px; width: 100%; box-sizing: border-box;"
    />
    <input
            type="text"
            id="search-bar-year"
            placeholder="Search by Year"
            oninput="searchMoviesByYear()"
            style="margin-bottom: 20px; padding: 10px; width: 100%; box-sizing: border-box;"
    />
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <label for="page-size-selector">Movies per page:</label>
            <select id="page-size-selector" onchange="updatePageSize(this.value)">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="25" selected>25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
        </div>
    </div>
</div>
<table>
    <thead>
    <tr>
        <th>No.</th>
        <th onclick="changeSorting('title')">
            Title <span id="title-sort-arrow"></span>
        </th>
        <th onclick="changeSorting('genre')">
            Genre <span id="genre-sort-arrow"></span>
        </th>
        <th onclick="changeSorting('year')">
            Year <span id="year-sort-arrow"></span>
        </th>
        <th onclick="changeSorting('boxOffice')">
            Box Office <span id="boxOffice-sort-arrow"></span>
        </th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody id="movie-table-body">
    <!-- Movies will be dynamically inserted here -->
    </tbody>
</table>
<div class="pagination" id="pagination">
    <!-- Pagination buttons will be dynamically added here -->
</div>

<!--<script src="script.js"></script>-->
</body>
<script>
    const apiUrl = 'http://localhost:8080/api/movies/filter'; // Replace with your API endpoint

    let currentPage = 0;
    let pageSize = 25;

    let sortDirection = 'desc';
    let sortBy = '';

    let searchTitle = '';
    let searchGenre = '';
    let searchYear = '';

    async function fetchMovies(page = 0, size = 5) {
        try {
            const response = await fetch(
                `${apiUrl}?page=${page}&size=${size}&sortBy=${sortBy}&sortDirection=${sortDirection}&title=${searchTitle}&genre=${searchGenre}&year=${searchYear}`);
            const data = await response.json();
            console.log(data)
            populateTable(data.content);
            setupPagination(data.totalPages);
        } catch (error) {
            console.error('Error fetching movies:', error);
        }
    }

    function populateTable(movies) {
        const tableBody = document.getElementById('movie-table-body');
        tableBody.innerHTML = ''; // Clear previous rows
        let i = 1;
        movies.forEach(movie => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${currentPage * pageSize + i}.</td>
            <td>${movie.Title}</td>
            <td>${movie.Genre}</td>
            <td>${movie.Year}</td>
            <td>${movie.BoxOffice ? `$${movie.BoxOffice.toLocaleString()}` : 'N/A'}</td>
            <td>
                <button class="star-button" onclick="this.textContent = this.textContent === '★' ? '☆' : '★';">☆</button>
                <button class="delete" onclick="deleteMovie('${movie.id}')">Delete</button>
            </td>
        `;
            tableBody.appendChild(row);
            i = i + 1;
        });
    }

    function setupPagination(totalPages) {
        const paginationDiv = document.getElementById('pagination');
        paginationDiv.innerHTML = '';
        for (let i = 0; i < totalPages; i++) {
            const button = document.createElement('button');
            button.textContent = i + 1;
            if (i === currentPage) {
                button.classList.add('selected');
            }
            button.onclick = () => {
                currentPage = i;
                fetchMovies(currentPage, pageSize);
            };
            paginationDiv.appendChild(button);
        }
    }

    function changeSorting(columnClicked){
        sortBy = columnClicked;
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';

        // Clear all arrows
        document.querySelectorAll('th span').forEach(span => {
            span.textContent = '';
        });

        // Update arrow for the sorted column
        const arrowSpan = document.getElementById(`${columnClicked}-sort-arrow`);
        if (arrowSpan) {
            arrowSpan.textContent = sortDirection === 'asc' ? '▼' : '▲';
        }

        fetchMovies(currentPage, pageSize);
    }

    // Handle search input changes
    function searchMoviesByTitle() {
        const searchBar = document.getElementById('search-bar-title');
        searchTitle = searchBar.value.trim();
        fetchMovies(0, pageSize); // Reset to the first page when searching
    }

    function searchMoviesByGenre() {
        const searchBar = document.getElementById('search-bar-genre');
        searchGenre = searchBar.value.trim();
        fetchMovies(0, pageSize);
        console.log("searchGenre");
    }

    function searchMoviesByYear() {
        const searchBar = document.getElementById('search-bar-year');
        searchYear = searchBar.value.trim();
        fetchMovies(0, pageSize); // Reset to the first page when searching
    }

    function updatePageSize(size) {
        pageSize = parseInt(size, 10); // Convert the value to an integer
        currentPage = 0; // Reset to the first page when the page size changes
        fetchMovies(currentPage, pageSize); // Fetch movies with the updated page size
    }

    // Delete movie function
    async function deleteMovie(movieId) {
        if (confirm('Are you sure you want to delete this movie?')) {
            try {
                const response = await fetch(`http://localhost:8080/api/movies/delete/${movieId}`, {
                    method: 'DELETE',
                });
                if (response.ok) {
                    alert('Movie deleted successfully!');
                    fetchMovies(currentPage, pageSize); // Refresh table
                } else {
                    alert('Failed to delete movie.');
                }
            } catch (error) {
                console.error('Error deleting movie:', error);
            }
        }
    }

    // Initialize the table
    fetchMovies(currentPage, pageSize);
</script>
</html>